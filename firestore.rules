rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================================
    // USER PROFILE VALIDATION
    // ============================================================

    // Validate user profile data for creation
    function isValidUserProfile() {
      let data = request.resource.data;
      return data.keys().hasAll(['uid', 'email', 'displayName', 'profileImageUrl', 'os', 'lastLoginTime'])
        && data.uid is string
        && data.email is string
        && data.displayName is string
        && data.profileImageUrl is string
        && data.os is string
        && data.lastLoginTime is timestamp;
    }

    // Validate profile update - BLOCKS all credit-related fields
    // SECURITY: These fields can ONLY be modified by Cloud Functions (Admin SDK)
    // - credits: Current credit balance
    // - maxCredits: Maximum credit cap based on plan
    // - plan: Subscription plan (free, monthly_pro, annual_pro)
    // - lastMonthlyGrant: Timestamp of last monthly credit grant
    // - createdAt: User creation timestamp (immutable)
    // - usedFreeOnboardingGeneration: Tracks if free onboarding generation was used
    // - activeGenerations: Rate limiting counter for concurrent generations
    // - lastGenerationAt: Rate limiting timestamp for cooldown
    function isValidProfileUpdate() {
      let updatedKeys = request.resource.data.diff(resource.data).affectedKeys();

      // CRITICAL: These fields are PROTECTED and can NEVER be modified by clients
      // Only Cloud Functions with Admin SDK can modify these fields
      let protectedFields = ['credits', 'maxCredits', 'plan', 'lastMonthlyGrant', 'createdAt', 'uid', 'email', 'usedFreeOnboardingGeneration', 'activeGenerations', 'lastGenerationAt'].toSet();

      // Allowed fields that users CAN update
      let allowedKeys = ['displayName', 'profileImageUrl', 'profileImageScale', 'profileImageOffsetX', 'profileImageOffsetY', 'lastLoginTime', 'os', 'onboardingCompleted', 'onboardingCompletedAt', 'signedUpDuringOnboarding', 'selectedTheme'].toSet();

      // SECURITY CHECK: Reject if ANY protected field is being modified
      // This prevents malicious clients from tampering with credit system
      let noProtectedFieldsModified = !updatedKeys.hasAny(protectedFields);

      // Ensure only allowed fields are being updated
      let onlyAllowedFields = updatedKeys.hasOnly(allowedKeys);

      return noProtectedFieldsModified && onlyAllowedFields;
    }

    // ============================================================
    // USERS COLLECTION RULES
    // ============================================================
    match /users/{userId} {
      // Allow users to read their own profile (includes credit info for UI display)
      allow read: if isOwner(userId);

      // Allow users to create their own profile with valid data
      // NOTE: Initial credit fields (credits, maxCredits, plan, lastMonthlyGrant)
      // are set by Cloud Function onUserCreated, NOT by client
      allow create: if isOwner(userId) && isValidUserProfile();

      // Allow users to update their own profile with valid data
      // SECURITY: Credit-related fields are BLOCKED - see isValidProfileUpdate()
      allow update: if isOwner(userId) && isValidProfileUpdate();

      // Don't allow deletion of profiles
      allow delete: if false;
    }

    // ============================================================
    // SUBSCRIPTIONS COLLECTION RULES
    // ============================================================
    // Subscription data is managed ONLY by Cloud Functions
    // Contains: productId, plan, expiresDate, status, lastCreditGrant
    match /subscriptions/{userId} {
      // Allow users to read their own subscription data (for UI display)
      allow read: if isOwner(userId);

      // SECURITY: All writes are BLOCKED for clients
      // Only Cloud Functions (Admin SDK) can create/update/delete subscriptions
      // This prevents users from tampering with their subscription status
      allow write: if false;
    }

    // ============================================================
    // PROCESSED TRANSACTIONS COLLECTION RULES
    // ============================================================
    // Tracks processed one-time purchases (credit top-ups) to prevent replay attacks
    // Contains: uid, productId, transactionId, creditsGranted, processedAt
    match /processedTransactions/{transactionId} {
      // Allow users to read their own processed transactions (for debugging/support)
      allow read: if isAuthenticated() && resource.data.uid == request.auth.uid;

      // SECURITY: All writes are BLOCKED for clients
      // Only Cloud Functions (Admin SDK) can create processed transaction records
      // This prevents users from tampering with transaction processing
      allow write: if false;
    }

    // ============================================================
    // DEFAULT DENY RULE
    // ============================================================
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
